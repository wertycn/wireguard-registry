# 集群模式设计

## 设计理念

本项目采用 **无状态节点 + 共享存储** 的简化集群设计，避免了复杂的节点间通信机制。

## 架构原则

### 1. 节点无状态
- 每个节点都是完全无状态的
- 不存储任何本地状态信息
- 任何节点都可以处理任何请求

### 2. 存储驱动
- **单机模式**: 使用内存存储或本地数据库（SQLite）
- **集群模式**: 强制使用分布式存储（MySQL、MongoDB）

### 3. 简化设计
- 不实现节点发现机制
- 不实现节点健康检查
- 不实现节点间通信
- 不实现负载均衡

## 模式对比

| 特性 | 单机模式 | 集群模式 |
|------|----------|----------|
| 节点数量 | 1 | N |
| 状态存储 | 内存/SQLite | MySQL/MongoDB |
| 数据一致性 | 单节点 | 数据库保证 |
| 扩展性 | 无 | 水平扩展 |
| 部署复杂度 | 低 | 中等 |

## 配置方式

### 单机模式
```yaml
wireguard:
  registry:
    mode: standalone
```

使用 Spring Profile: `memory` 或 `sqlite`

### 集群模式
```yaml
wireguard:
  registry:
    mode: cluster
    node-id: "node-001"  # 可选，空则自动生成
```

使用 Spring Profile: `mysql` 或 `mongodb`

## 部署架构

### 单机部署
```
[Load Balancer] → [WG Registry Node] → [Memory/SQLite]
```

### 集群部署
```
[Load Balancer] → [WG Registry Node 1] ↘
                 [WG Registry Node 2] → [Shared Database]
                 [WG Registry Node N] ↗
```

## 数据一致性

### 单机模式
- 单节点，天然一致性

### 集群模式
- 依赖数据库的 ACID 特性
- 所有节点访问相同的数据库
- 数据库负责数据一致性保证

## 优势

1. **简单性**: 无复杂的集群协议
2. **可靠性**: 依赖成熟的数据库技术
3. **可扩展性**: 水平扩展只需添加节点
4. **运维友好**: 标准的数据库运维经验

## 注意事项

1. **数据库是单点**: 需要数据库高可用方案
2. **网络延迟**: 节点与数据库间的网络延迟影响性能
3. **数据库连接**: 需要合理配置连接池
4. **负载均衡**: 需要外部负载均衡器

## 与传统集群的区别

| 传统集群 | 本项目 |
|----------|--------|
| 节点间通信 | 无通信 |
| 状态同步 | 数据库保证 |
| 故障检测 | 负载均衡器检测 |
| 数据分片 | 全量共享 |
| 一致性协议 | 数据库 ACID |

## 总结

这种设计将集群的复杂性下沉到数据库层，应用层保持简单。每个节点都是独立的、无状态的，通过共享数据库实现数据一致性。这种架构在实际生产环境中是成熟、可靠的解决方案。