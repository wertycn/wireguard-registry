<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8"/>
    <title>ç®¡ç†é¡µé¢æµ‹è¯•</title>
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/amis/3.4.0/sdk.css"/>
    <style>
        body {
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        .test-info {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="test-info">
        <h2>ç®¡ç†é¡µé¢æµ‹è¯•</h2>
        <p>è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•å…¨å±€requestAdaptoræ˜¯å¦æ­£å¸¸å·¥ä½œ</p>
        <p>è¯·å…ˆç™»å½•ï¼Œç„¶åæŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°è¾“å‡º</p>
    </div>
    
    <div id="root"></div>
    
    <script type="text/javascript" src="https://cdn.bootcdn.net/ajax/libs/amis/3.4.0/sdk.min.js"></script>
    <script type="text/javascript">
        let myAmis;
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
        function checkAuth() {
            const token = localStorage.getItem('admin_token');
            console.log('Token check:', token ? 'present' : 'missing');
            if (!token) {
                alert('è¯·å…ˆç™»å½•ï¼');
                window.location.href = '/login.html';
                return false;
            }
            return true;
        }
        
        (function () {
            if (!checkAuth()) {
                return;
            }
            
            myAmis = amisRequire('amis/embed');
            
            // ç®€å•çš„ç”¨æˆ·åˆ—è¡¨æµ‹è¯•é¡µé¢
            let page = {
                "type": "page",
                "title": "ç”¨æˆ·åˆ—è¡¨æµ‹è¯•",
                "body": [
                    {
                        "type": "crud",
                        "api": "get:/v1/admin/users",
                        "columns": [
                            {
                                "name": "username",
                                "label": "ç”¨æˆ·å"
                            },
                            {
                                "name": "email",
                                "label": "é‚®ç®±"
                            },
                            {
                                "name": "roles",
                                "label": "è§’è‰²",
                                "type": "tags"
                            },
                            {
                                "name": "active",
                                "label": "çŠ¶æ€",
                                "type": "status",
                                "map": {
                                    "true": {
                                        "value": "å¯ç”¨",
                                        "status": "success"
                                    },
                                    "false": {
                                        "value": "ç¦ç”¨",
                                        "status": "fail"
                                    }
                                }
                            }
                        ]
                    }
                ]
            };
            
            myAmis.embed("#root", page, {}, {
                // å…¨å±€è¯·æ±‚é€‚é…å™¨
                requestAdaptor: function(api) {
                    const token = localStorage.getItem('admin_token');
                    console.log('ğŸ”§ requestAdaptor called for:', api.url);
                    console.log('ğŸ”§ Token:', token ? 'present' : 'missing');
                    
                    if (token) {
                        api.headers = api.headers || {};
                        api.headers.Authorization = `Bearer ${token}`;
                        console.log('ğŸ”§ Added Authorization header');
                    }
                    
                    console.log('ğŸ”§ Final API config:', api);
                    return api;
                },
                
                // å…¨å±€å“åº”é€‚é…å™¨
                responseAdaptor: function(api, payload, query, request, response) {
                    console.log('ğŸ“¡ responseAdaptor called for:', api.url);
                    console.log('ğŸ“¡ Response status:', response.status);
                    console.log('ğŸ“¡ Response payload:', payload);
                    
                    // å¤„ç†401æœªæˆæƒé”™è¯¯
                    if (response.status === 401) {
                        console.log('âŒ 401 error detected, clearing token and redirecting to login');
                        localStorage.removeItem('admin_token');
                        window.location.href = '/login.html';
                        return;
                    }
                    
                    return payload;
                }
            });
        })();
    </script>
</body>
</html> 